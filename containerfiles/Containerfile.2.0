# Tag 2.0 - CentOS Stream 10 Bootc Image with FIPS
# Builds on 1.0 and adds FIPS mode
# Reference: https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/10/html/using_image_mode_for_rhel_to_build_deploy_and_manage_operating_systems/assembly_enabling-fips-mode-in-a-bootc-image-build_using-image-mode-for-rhel-to-build-deploy-and-manage-operating-systems

FROM localhost/bootc-demo:1.0

# Copy FIPS kernel arguments configuration
COPY 01-fips.toml /usr/lib/bootc/kargs.d/

# Install crypto-policies-scripts and enable FIPS cryptographic policy
RUN dnf install -y crypto-policies-scripts && \
    update-crypto-policies --no-reload --set FIPS && \
    dnf clean all

# Update hostname
RUN echo "bootc-demo-v2" > /etc/hostname

# Update MOTD
RUN echo "========================================" > /etc/motd && \
    echo "CentOS Stream 10 Bootc Demo v2.0" >> /etc/motd && \
    echo "Base image + FIPS mode enabled" >> /etc/motd && \
    echo "" >> /etc/motd && \
    echo "Verify FIPS status with:" >> /etc/motd && \
    echo "  cat /proc/sys/crypto/fips_enabled" >> /etc/motd && \
    echo "  update-crypto-policies --show" >> /etc/motd && \
    echo "========================================" >> /etc/motd

# Best practice: Run bootc linter as final step
RUN bootc container lint || true
