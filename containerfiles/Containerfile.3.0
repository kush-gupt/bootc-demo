# Tag 3.0 - CentOS Stream 10 Bootc Image with FIPS and DISA STIG
# Builds on 2.0 and adds DISA STIG hardening
# Reference: https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/10/html/using_image_mode_for_rhel_to_build_deploy_and_manage_operating_systems/assembly_security-hardening-and-compliance-of-bootable-images_using-image-mode-for-rhel-to-build-deploy-and-manage-operating-systems

FROM localhost/bootc-demo:2.0

# Install OpenSCAP scanner and security content
# Using oscap-im tool which is specifically designed for bootable container images
RUN dnf install -y \
    openscap-utils \
    scap-security-guide \
    && dnf clean all

# Create a sudo user before applying STIG profile
# STIG profile prevents SSH root logins, so we need a sudo user
# Password hash for 'bootc' generated with: openssl passwd -6 -salt saltsaltlettuce bootc
RUN useradd -G wheel -p '$6$rounds=4096$saltsaltlettuce$YwMRfMLRv62PbqPBqGI2LMFoM4LFwZ3hd4W5lZb9A9A3xJ4I.E/u4F3B8j1jq3YJJdgcKlkPq5Vz1vFW0Q1Q21' bootc-user

# Run oscap-im to scan and remediate the image for STIG compliance
# This is the best practice tool for bootable containers
# Note: Some remediations may not apply in container context but will be enforced when deployed
RUN oscap-im --profile xccdf_org.ssgproject.content_profile_stig \
    /usr/share/xml/scap/ssg/content/ssg-cs10-ds.xml || true

# Update hostname
RUN echo "bootc-demo-v3" > /etc/hostname

# Update MOTD
RUN echo "========================================" > /etc/motd && \
    echo "CentOS Stream 10 Bootc Demo v3.0" >> /etc/motd && \
    echo "Base + FIPS + DISA STIG hardening" >> /etc/motd && \
    echo "" >> /etc/motd && \
    echo "FIPS enabled - verify with:" >> /etc/motd && \
    echo "  cat /proc/sys/crypto/fips_enabled" >> /etc/motd && \
    echo "" >> /etc/motd && \
    echo "STIG compliance scan:" >> /etc/motd && \
    echo "  sudo oscap xccdf eval --profile \\" >> /etc/motd && \
    echo "    xccdf_org.ssgproject.content_profile_stig \\" >> /etc/motd && \
    echo "    /usr/share/xml/scap/ssg/content/ssg-cs10-ds.xml" >> /etc/motd && \
    echo "========================================" >> /etc/motd

# Best practice: Run bootc linter as final step
RUN bootc container lint || true
