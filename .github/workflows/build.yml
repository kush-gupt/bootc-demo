name: Build and Push Bootc Images

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU for multi-arch builds
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64,amd64

      - name: Set up Podman
        run: |
          sudo apt-get update
          sudo apt-get -y install podman

      - name: Log in to Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Extract metadata
        id: meta
        run: |
          echo "date=$(date +%Y%m%d)" >> $GITHUB_OUTPUT
          echo "sha_short=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      # ========================================================================
      # Build Image 1.0 (Vanilla) - Multi-arch
      # ========================================================================
      
      - name: Build Image 1.0 for AMD64
        run: |
          cd containerfiles
          podman build --squash --platform linux/amd64 \
            -f Containerfile.1.0 \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:1.0-amd64 \
            .

      - name: Build Image 1.0 for ARM64
        run: |
          cd containerfiles
          podman build --squash --platform linux/arm64 \
            -f Containerfile.1.0 \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:1.0-arm64 \
            .

      - name: Push Image 1.0 (both architectures)
        run: |
          podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:1.0-amd64
          podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:1.0-arm64

      - name: Create and Push Manifest for 1.0
        run: |
          podman manifest create ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:1.0
          podman manifest add ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:1.0 \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:1.0-amd64
          podman manifest add ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:1.0 \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:1.0-arm64
          podman manifest push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:1.0
          
          # Create dated manifest
          podman manifest create ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:1.0-${{ steps.meta.outputs.date }}
          podman manifest add ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:1.0-${{ steps.meta.outputs.date }} \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:1.0-amd64
          podman manifest add ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:1.0-${{ steps.meta.outputs.date }} \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:1.0-arm64
          podman manifest push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:1.0-${{ steps.meta.outputs.date }}

      # ========================================================================
      # Build Image 2.0 (FIPS) - Multi-arch
      # ========================================================================
      
      - name: Build Image 2.0 for AMD64
        run: |
          cd containerfiles
          podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:1.0-amd64
          podman tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:1.0-amd64 localhost/bootc-demo:1.0
          podman build --squash --platform linux/amd64 \
            -f Containerfile.2.0 \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:2.0-amd64 \
            .

      - name: Build Image 2.0 for ARM64
        run: |
          cd containerfiles
          podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:1.0-arm64
          podman tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:1.0-arm64 localhost/bootc-demo:1.0
          podman build --squash --platform linux/arm64 \
            -f Containerfile.2.0 \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:2.0-arm64 \
            .

      - name: Push Image 2.0 (both architectures)
        run: |
          podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:2.0-amd64
          podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:2.0-arm64

      - name: Create and Push Manifest for 2.0
        run: |
          podman manifest create ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:2.0
          podman manifest add ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:2.0 \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:2.0-amd64
          podman manifest add ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:2.0 \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:2.0-arm64
          podman manifest push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:2.0
          
          # Create dated manifest
          podman manifest create ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:2.0-${{ steps.meta.outputs.date }}
          podman manifest add ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:2.0-${{ steps.meta.outputs.date }} \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:2.0-amd64
          podman manifest add ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:2.0-${{ steps.meta.outputs.date }} \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:2.0-arm64
          podman manifest push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:2.0-${{ steps.meta.outputs.date }}

      # ========================================================================
      # Build Image 3.0 (FIPS + STIG) - Multi-arch
      # ========================================================================
      
      - name: Build Image 3.0 for AMD64
        run: |
          cd containerfiles
          podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:2.0-amd64
          podman tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:2.0-amd64 localhost/bootc-demo:2.0
          podman build --squash --platform linux/amd64 \
            -f Containerfile.3.0 \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:3.0-amd64 \
            .

      - name: Build Image 3.0 for ARM64
        run: |
          cd containerfiles
          podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:2.0-arm64
          podman tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:2.0-arm64 localhost/bootc-demo:2.0
          podman build --squash --platform linux/arm64 \
            -f Containerfile.3.0 \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:3.0-arm64 \
            .

      - name: Push Image 3.0 (both architectures)
        run: |
          podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:3.0-amd64
          podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:3.0-arm64

      - name: Create and Push Manifest for 3.0
        run: |
          podman manifest create ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:3.0
          podman manifest add ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:3.0 \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:3.0-amd64
          podman manifest add ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:3.0 \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:3.0-arm64
          podman manifest push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:3.0
          
          # Create dated manifest
          podman manifest create ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:3.0-${{ steps.meta.outputs.date }}
          podman manifest add ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:3.0-${{ steps.meta.outputs.date }} \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:3.0-amd64
          podman manifest add ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:3.0-${{ steps.meta.outputs.date }} \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:3.0-arm64
          podman manifest push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:3.0-${{ steps.meta.outputs.date }}

      # ========================================================================
      # Build Image 4.0 (FIPS + STIG + WebApp) - Multi-arch
      # ========================================================================
      
      - name: Build Image 4.0 for AMD64
        run: |
          podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:3.0-amd64
          podman tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:3.0-amd64 localhost/bootc-demo:3.0
          podman build --squash --platform linux/amd64 \
            -f containerfiles/Containerfile.4.0 \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:4.0-amd64 \
            .

      - name: Build Image 4.0 for ARM64
        run: |
          podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:3.0-arm64
          podman tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:3.0-arm64 localhost/bootc-demo:3.0
          podman build --squash --platform linux/arm64 \
            -f containerfiles/Containerfile.4.0 \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:4.0-arm64 \
            .

      - name: Push Image 4.0 (both architectures)
        run: |
          podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:4.0-amd64
          podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:4.0-arm64

      - name: Create and Push Manifests for 4.0 and latest
        run: |
          # Create 4.0 manifest
          podman manifest create ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:4.0
          podman manifest add ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:4.0 \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:4.0-amd64
          podman manifest add ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:4.0 \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:4.0-arm64
          podman manifest push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:4.0
          
          # Create dated manifest
          podman manifest create ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:4.0-${{ steps.meta.outputs.date }}
          podman manifest add ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:4.0-${{ steps.meta.outputs.date }} \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:4.0-amd64
          podman manifest add ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:4.0-${{ steps.meta.outputs.date }} \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:4.0-arm64
          podman manifest push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:4.0-${{ steps.meta.outputs.date }}
          
          # Create latest manifest
          podman manifest create ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          podman manifest add ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:4.0-amd64
          podman manifest add ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:4.0-arm64
          podman manifest push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      - name: Generate build summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Successfully built and pushed all multi-arch image tags:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- \`1.0\` - Vanilla CentOS Stream 10 (amd64, arm64)" >> $GITHUB_STEP_SUMMARY
          echo "- \`2.0\` - + FIPS Mode (amd64, arm64)" >> $GITHUB_STEP_SUMMARY
          echo "- \`3.0\` - + DISA STIG (amd64, arm64)" >> $GITHUB_STEP_SUMMARY
          echo "- \`4.0\` - + Modern Web App (amd64, arm64)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Features:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ—ï¸ Multi-architecture support (amd64 + arm64)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Single-layer squashed images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull Commands:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Automatically pulls the correct architecture for your system" >> $GITHUB_STEP_SUMMARY
          echo "podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:1.0" >> $GITHUB_STEP_SUMMARY
          echo "podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:2.0" >> $GITHUB_STEP_SUMMARY
          echo "podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:3.0" >> $GITHUB_STEP_SUMMARY
          echo "podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:4.0" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Inspect Multi-arch Manifest:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "podman manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:4.0" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
